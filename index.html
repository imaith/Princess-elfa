<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Rescue Princess Elfa!</title>
<style>
  body { margin: 0; overflow: hidden; background: #222; font-family: 'Courier New', Courier, monospace; touch-action: none; }
  canvas { display: block; margin: 0 auto; background: #5c94fc; }
  
  /* UI Overlay */
  #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  
  /* Hearts Health */
  #health-bar { position: absolute; top: 20px; right: 20px; font-size: 24px; color: red; text-shadow: 2px 2px 0 #000; }
  
  /* Proposal Box */
  #proposal { 
    display: none; pointer-events: auto; background: rgba(255, 255, 255, 0.95); 
    padding: 20px; border-radius: 15px; border: 4px solid #ff69b4; text-align: center; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 80%;
  }
  h1 { color: #ff1493; margin: 0 0 10px 0; font-size: 20px; }
  p { color: #333; font-size: 16px; margin-bottom: 20px; }
  
  .btn { 
    border: none; padding: 12px 25px; margin: 5px; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; 
    transition: transform 0.1s;
  }
  .btn-yes { background: #ff1493; color: white; }
  .btn-no { background: #ccc; color: #333; }
  .btn:active { transform: scale(0.95); }

  /* Mobile Controls Hint */
  #controls-hint {
    position: absolute; bottom: 20px; width: 100%; text-align: center; color: rgba(255,255,255,0.7); font-size: 14px; pointer-events: none;
    animation: fadeOut 3s forwards 2s;
  }
  @keyframes fadeOut { to { opacity: 0; } }
</style>
</head>
<body>

<div id="ui-layer">
    <div id="health-bar">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    
    <div id="proposal">
        <h1>You saved Princess Elfa! üëë</h1>
        <p>She looks at you with sparkling eyes...</p>
        <p><strong>"Will you be my Valentine?"</strong></p>
        <button class="btn btn-yes" onclick="handleYes()">YES! üíñ</button>
        <button class="btn btn-no" onclick="handleNo()">NO...</button>
    </div>
</div>

<div id="controls-hint">Hold Sides to Move ‚Ä¢ Tap Top to Jump</div>
<canvas id="game"></canvas>

<script>
/* --- 1. SETUP & ASSETS --- */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// Responsive Canvas
let SCALE = 2; // Pixel art scale
function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    SCALE = Math.min(canvas.width / 300, canvas.height / 200);
    ctx.imageSmoothingEnabled = false;
}
window.addEventListener('resize', resize);
resize();

// --- PIXEL ART GENERATOR ---
// This function creates images from text arrays so we don't need external files!
function createSprite(pixels, colors) {
    const s = 1; // scale of internal pixel
    const w = pixels[0].length;
    const h = pixels.length;
    const c = document.createElement('canvas');
    c.width = w * s; c.height = h * s;
    const x = c.getContext('2d');
    for(let i=0; i<h; i++) {
        for(let j=0; j<w; j++) {
            if(pixels[i][j] !== ' ') {
                x.fillStyle = colors[pixels[i][j]];
                x.fillRect(j*s, i*s, s, s);
            }
        }
    }
    return c;
}

// Art Definitions (Boy, Girl, Boss, Brick)
const boyArt = [
    "  RRR  ",
    " RRRR  ",
    "  YY   ",
    " BBRB  ",
    " BBRB  ",
    "  R R  ",
    " BB BB "
];
const boyColors = { 'R': '#e70010', 'B': '#2332d1', 'Y': '#ffcc99' }; // Mario-ish

const girlArt = [
    "  BB   ",
    " BBBBB ",
    "  YY   ",
    " PPPP  ",
    " PPPP  ",
    " P  P  ",
    " Y  Y  "
];
const girlColors = { 'B': 'black', 'P': '#ff69b4', 'Y': '#ffcc99' };

const bossArt = [
    "  GG   ",
    " GGGGG ",
    "GGRRGGG",
    " GGGGG ",
    " G Y G ",
    "G G G G"
];
const bossColors = { 'G': '#32cd32', 'R': '#ff4500', 'Y': '#ffff00' };

const brickArt = [
    "BBBB",
    "B  B",
    "BBBB",
    "B  B"
];
const brickColors = { 'B': '#8b4513' };

const sprites = {
    boy: createSprite(boyArt, boyColors),
    girl: createSprite(girlArt, girlColors),
    boss: createSprite(bossArt, bossColors),
    brick: createSprite(brickArt, brickColors)
};

/* --- 2. GAME ENGINE --- */
let gameState = "PLAYING"; // PLAYING, WON, CUTSCENE
let cameraX = 0;

const player = { x: 50, y: 100, w: 20, h: 20, vx: 0, vy: 0, grounded: false, facingRight: true, animTimer: 0 };
const boss = { x: 600, y: 100, w: 40, h: 40, vx: -1, hp: 3, dead: false, iframes: 0 };
const princess = { x: 750, y: 160, w: 20, h: 20 };

// Level Design (x, y, width, height)
const platforms = [
    {x: -100, y: 200, w: 1000, h: 50}, // Ground
    {x: 200, y: 140, w: 80, h: 20},
    {x: 350, y: 100, w: 80, h: 20},
    {x: 500, y: 140, w: 80, h: 20},
    {x: 700, y: 200, w: 200, h: 50} // Princess platform
];

// Controls
const input = { left: false, right: false, jump: false };

function handleTouch(e) {
    e.preventDefault();
    input.left = false; input.right = false; input.jump = false;
    
    for (let i = 0; i < e.touches.length; i++) {
        let t = e.touches[i];
        let x = t.clientX;
        let y = t.clientY;
        
        if (y < window.innerHeight * 0.4) {
            input.jump = true;
        } else {
            if (x < window.innerWidth * 0.5) input.left = true;
            else input.right = true;
        }
    }
}

document.addEventListener("touchstart", handleTouch, {passive: false});
document.addEventListener("touchmove", handleTouch, {passive: false});
document.addEventListener("touchend", (e) => {
    if(e.touches.length === 0) { input.left = false; input.right = false; input.jump = false; }
    else handleTouch(e);
});
// Keyboard Support
document.addEventListener("keydown", e => {
    if(e.code==="ArrowLeft") input.left=true;
    if(e.code==="ArrowRight") input.right=true;
    if(e.code==="Space" || e.code==="ArrowUp") input.jump=true;
});
document.addEventListener("keyup", e => {
    if(e.code==="ArrowLeft") input.left=false;
    if(e.code==="ArrowRight") input.right=false;
    if(e.code==="Space" || e.code==="ArrowUp") input.jump=false;
});

/* --- 3. PHYSICS & LOGIC --- */
function update() {
    if (gameState === "CUTSCENE") return;

    // Player Move
    if (input.left) { player.vx = -4; player.facingRight = false; }
    else if (input.right) { player.vx = 4; player.facingRight = true; }
    else { player.vx *= 0.8; } // Friction

    // Jump
    if (input.jump && player.grounded) {
        player.vy = -11;
        player.grounded = false;
    }

    // Gravity
    player.vy += 0.6;
    player.x += player.vx;
    player.y += player.vy;

    // Collision Player vs Platforms
    player.grounded = false;
    platforms.forEach(p => {
        if (player.x < p.x + p.w && player.x + player.w > p.x &&
            player.y + player.h > p.y && player.y + player.h < p.y + player.vy + 5) { // Check feet
            if (player.vy > 0) {
                player.y = p.y - player.h;
                player.vy = 0;
                player.grounded = true;
            }
        }
    });

    // Boss Logic
    if (!boss.dead) {
        boss.x += boss.vx;
        // Boss Patrol
        if (boss.x < 550 || boss.x > 750) boss.vx *= -1;

        // Player vs Boss
        if (player.x < boss.x + boss.w && player.x + player.w > boss.x &&
            player.y < boss.y + boss.h && player.y + player.h > boss.y) {
            
            // Hit head (Mario logic)
            if (player.vy > 0 && player.y + player.h < boss.y + 20) {
                boss.hp--;
                player.vy = -8; // Bounce
                boss.iframes = 20;
                updateHealth();
                if (boss.hp <= 0) {
                    boss.dead = true;
                    // Unlock Princess Path
                }
            } else if (boss.iframes <= 0) {
                // Hurt player (respawn at start)
                player.x = 50; player.y = 100;
            }
        }
        if (boss.iframes > 0) boss.iframes--;
    }

    // Win Condition
    if (boss.dead && Math.abs(player.x - princess.x) < 30) {
        gameState = "WON";
        document.getElementById("proposal").style.display = "block";
    }

    // Camera follow
    let targetCamX = player.x - canvas.width / (2 * SCALE);
    cameraX += (targetCamX - cameraX) * 0.1;
    if (cameraX < 0) cameraX = 0;
}

function updateHealth() {
    let h = "";
    for(let i=0; i<boss.hp; i++) h += "‚ù§Ô∏è";
    document.getElementById("health-bar").innerHTML = h;
}

/* --- 4. DRAWING --- */
function draw() {
    // Clear Background
    ctx.fillStyle = "#87CEEB"; // Sky Blue
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    ctx.scale(SCALE, SCALE);
    ctx.translate(-cameraX, 0);

    // Draw Platforms
    ctx.fillStyle = "#228B22";
    platforms.forEach(p => {
        // Draw Tiled Grass
        for(let i=0; i<p.w; i+=20) {
             ctx.drawImage(sprites.brick, p.x+i, p.y, 20, 20);
        }
    });

    // Draw Boss
    if (!boss.dead) {
        if (boss.iframes % 4 < 2) { // Flicker if hit
            ctx.drawImage(sprites.boss, boss.x, boss.y, boss.w, boss.h);
        }
    }

    // Draw Princess
    ctx.drawImage(sprites.girl, princess.x, princess.y, 20, 20);

    // Draw Player
    ctx.save();
    if (!player.facingRight) {
        ctx.translate(player.x + player.w, player.y);
        ctx.scale(-1, 1);
        ctx.drawImage(sprites.boy, 0, 0, player.w, player.h);
    } else {
        ctx.drawImage(sprites.boy, player.x, player.y, player.w, player.h);
    }
    ctx.restore();

    ctx.restore(); // End Camera

    requestAnimationFrame(loop);
}

function loop() {
    update();
    draw();
}

/* --- 5. ENDING LOGIC --- */
function handleYes() {
    document.getElementById("proposal").innerHTML = "<h1>YAYYYYY! üíï</h1><p>Happy Valentine's Day!</p>";
    gameState = "CUTSCENE";
    // Kiss Animation
    let kissLoop = setInterval(() => {
        if (player.x < princess.x - 10) player.x += 1;
        else {
            clearInterval(kissLoop);
            // Draw hearts
            const heart = document.createElement("div");
            heart.innerText = "üíñ";
            heart.style.position = "absolute";
            heart.style.left = "50%"; heart.style.top = "50%";
            heart.style.fontSize = "50px";
            heart.style.animation = "fadeOut 2s forwards";
            document.body.appendChild(heart);
        }
    }, 50);
}

function handleNo() {
    document.getElementById("proposal").innerHTML = "<h1>üò≠ Pleaseeeee üò≠</h1><button class='btn btn-yes' onclick='handleYes()'>Okay fine YES üíñ</button>";
    // Crying Animation
    let shakeDir = 1;
    setInterval(() => {
        player.x += shakeDir * 2;
        shakeDir *= -1;
    }, 50);
}

// Start
loop();
</script>
</body>
</html>
